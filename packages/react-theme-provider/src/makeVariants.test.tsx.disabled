import * as React from 'react';
import { makeVariants } from './makeVariants';
import { Stylesheet, InjectionMode } from '@uifabric/merge-styles';
import { ReactWrapper } from 'enzyme';
import { ThemeProvider } from './ThemeProvider';
import { safeMount } from '@uifabric/test-utilities';

describe('makeVariants', () => {
  const _stylesheet: Stylesheet = Stylesheet.getInstance();

  _stylesheet.setConfig({ injectionMode: InjectionMode.none });

  beforeEach(() => {
    _stylesheet.reset();
  });

  const useVariants = makeVariants('Button', '--button', {
    base: {
      background: 'red',
    },
    primary: {
      background: 'green',
    },
  });

  const Foo = (props: { className?: string; primary?: boolean }) => {
    const state = { ...props };

    useVariants(state);

    return <button className={state.className} />;
  };

  fit('can render default base variant', () => {
    safeMount(
      <ThemeProvider>
        <Foo />
      </ThemeProvider>,
      (wrapper: ReactWrapper) => {
        expect(
          wrapper
            .first()
            .getDOMNode()
            .getAttribute('class'),
        ).toEqual('Button-0');
        expect(_stylesheet.getRules()).toEqual('.Button-0{--button-background:red;}');
      },
    );
  });

  it('can render primary variant', () => {
    safeMount(<Foo primary />, (wrapper: ReactWrapper) => {
      expect(wrapper.getDOMNode().getAttribute('class')).toEqual(' Button-primary-0');
      expect(_stylesheet.getRules()).toEqual('.Button-primary-0{--button-background:green;}');
    });
  });

  it('can respect themed variant overrides', () => {
    safeMount(
      <ThemeProvider
        theme={{
          variants: {
            Foo: {
              primary: {
                background: 'purple',
              },
            },
          },
        }}
      >
        <Foo primary />
      </ThemeProvider>,
      (wrapper: ReactWrapper) => {
        expect(wrapper.getDOMNode().getAttribute('class')).toEqual(' Button-primary-0');
        expect(_stylesheet.getRules()).toEqual('.Button-primary-0{--button-background:purple;}');
      },
    );
  });
});
