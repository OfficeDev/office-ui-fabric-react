pr: none
trigger: none

pool:
  vmImage: 'Ubuntu 16.04'

variables:
  - group: 'Github and NPM secrets'

steps:
  - checkout: self
    persistCredentials: true

  # - task: NodeTool@0
  #   inputs:
  #     versionSpec: '10.x'
  #   displayName: 'Install Node.js'

  # - script: |
  #     yarn
  #   displayName: yarn

  # - script: |
  #     yarn build --min
  #   displayName: build (no test or lint)

  # - script: |
  #     yarn update-snapshots
  #   displayName: update snapshots

  - script: |
      echo hello > packages/office-ui-fabric-react/src/components/hello.tsx.shot
    displayName: create test snapshot file

  - script: |
      git config --global user.email "fabrictactical@microsoft.com"
      git config --global user.name "Fabric Tactical"
    displayName: Set up git config user name and email

  - script: |
      if [ -n '$(git status --porcelain | grep -E "(\.snap|\.shot)")' ]; then
        noauthRemote=$(remote)
        echo ${noauthRemote/\/github.com/\/FAT@github.com/}
        git remote add target_remote ${noauthRemote/\/github.com/\/$(githubUser):$(githubPAT)@github.com/}
        git fetch target_remote
        git checkout -t target_remote/$(branch) -b target_branch
        git add *.shot *.snap
        git commit -m "updated snapshots"
        yarn change -m "updated snapshots" --type patch
        git -c http.extraheader="AUTHORIZATION: basic $(System.AccessToken)" push target_remote target_branch:$(branch)
      fi
    displayName: push changes back
