pr: none
trigger: none

# Customize build number to include major version
# Example: fluentui_20190626.1
name: 'fluentui_$(Date:yyyyMMdd)$(Rev:.r)'

variables:
  - group: 'Github and NPM secrets'
  - name: northstarVersion
    value: empty

pool: 'Self Host Ubuntu'

steps:
  - task: NodeTool@0
    inputs:
      versionSpec: '10.x'
    displayName: 'Install Node.js'

  - script: |
      git config user.name "Fluent UI Build"
      git config user.email "fluentui-internal@service.microsoft.com"
      git remote set-url origin https://$(githubUser):$(githubPAT)@github.com/microsoft/fluentui.git
    displayName: Authenticate git for pushes

  - script: |
      ver=`node -p "require('./packages/fluentui/react-northstar/package.json').version"`
      echo `##vso[task.setvariable variable=northstarVersion]$ver`
    displayName: Set N* version pipeline variable

  - script: |
      npx midgard-yarn install
    displayName: yarn

  - script: |
      PRODUCTION=true yarn build
    displayName: yarn build

  - script: |
      NODE_ENV=production yarn build:fluentui:docs
    displayName: yarn build:fluentui:docs

  - task: PublishBuildArtifacts@1
    displayName: 'Publish docsite as pipeline artifact'
    inputs:
      PathtoPublish: 'packages/fluentui/docs/dist'
      ArtifactName: 'docsite'

  - task: AzureUpload@2
    displayName: Upload docs site
    inputs:
      SourcePath: 'packages/fluentui/docs/dist'
      azureSubscription: 'UI Fabric (private)'
      # TODO change to actual storage account when ready
      storage: fluentsiteversiontest
      ContainerName: '$web'
      BlobPrefix: '$(northstarVersion)'
# No NPM release in CI for now
#  - script: |
#      yarn test
#    displayName: yarn test
#
#  - script: |
#      yarn lint
#    displayName: yarn lint
#
#  - script: |
#      yarn release:fluentui:$(bumpType)
#    displayName: yarn release:fluentui:$(bumpType)
